<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - EngineRoom</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='ER Logo_1749447115584.png') }}">
  <!-- Your main stylesheet (keep your existing CSS there) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/adam-chat-widget.css') }}">

  <!-- Mapbox (for the small address preview map in the "Add Project" modal) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    /* Minimal inline touches for modals/empty states. Keep heavy styles in dashboard.css */
    .modal[aria-hidden="true"] { display: none !important; }
    .modal[aria-hidden="false"] {
      display: flex; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,.5);
      align-items: center; justify-content: center;
    }
    .modal .modal-content {
      background: #fff; border-radius: 12px; width: min(900px, 92vw);
      box-shadow: 0 20px 60px rgba(0,0,0,.25); overflow: hidden;
    }
    .modal .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 24px 28px; border-bottom: 1px solid #eef2f7;
    }
    .modal .modal-body { padding: 24px 28px; }
    .modal .modal-actions { padding: 0 28px 28px; display: flex; gap: 10px; justify-content: flex-end; }
    .close-modal-btn { border: 0; background: #f7fafc; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; }
    .btn { cursor: pointer; border-radius: 8px; padding: 10px 16px; font-weight: 600; border: 1px solid transparent; }
    .btn-primary { background: linear-gradient(135deg, #547bf7, #4a6bda); color: #fff; }
    .btn-secondary { background: #fff; border-color: #d1d5db; color: #374151; }
    .btn-danger { background: linear-gradient(135deg, #dc2626, #b91c1c); color: #fff; }
    .search-input-wrapper { position: relative; }
    .search-input-wrapper .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: .6; }
    .no-data-message { text-align: center; color: #718096; padding: 40px 12px; }
    .badge { background: #e5edff; color: #3f5bd9; border-radius: 9999px; padding: 2px 8px; font-size: 12px; font-weight: 700; }
    .files-table-container { overflow: auto; }
    .files-table { width: 100%; border-collapse: collapse; }
    .files-table th, .files-table td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: left; }
    .pagination-container { display: none; align-items: center; justify-content: space-between; margin-top: 12px; }
    .pagination-btn, .pagination-page { border: 1px solid #d1d5db; background: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .pagination-page.active { background: #eef2ff; border-color: #c7d2fe; font-weight: 700; }
    .project-status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; }
    .project-status-badge.site-selection { background: #ecfeff; color: #155e75; }
    .project-status-badge.site-inspector { background: #eef2ff; color: #3730a3; }
    .project-status-badge.terrain-analysis { background: #f0fdf4; color: #065f46; }
    .project-status-badge.structure-designer { background: #fff7ed; color: #9a3412; }
    .project-status-badge.structural-analyser { background: #fdf2f8; color: #9d174d; }

    /* Tiny grid helpers for the modal form */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #2d3748; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;
    }
    .error-message { color: #dc2626; font-size: 12px; margin-top: 6px; }
    .segment-switch { display: inline-flex; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
    .segment-switch button { padding: 8px 12px; border: 0; background: #fff; cursor: pointer; font-weight: 600; }
    .segment-switch button.active { background: #eef2ff; color: #4338ca; }
    .map-shell { width: 100%; height: 320px; border-radius: 12px; overflow: hidden; background: #f8fafc; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">ER</div>
      <span class="logo-text">EngineRoom</span>
    </div>

    <div class="menu-section">
      <div class="menu-title">Menu</div>
      <a href="#" class="menu-item active">
        <div class="icon">üìã</div>
        Projects
        <div class="badge" id="projectCounter">0</div>
      </a>
      <a href="/team" class="menu-item" id="teamMenuItem" style="display:none;">
        <div class="icon">üë•</div>
        <div class="team-name-wrapper">
          <span id="teamMenuText">Team</span>
        </div>
      </a>
    </div>

    <div class="menu-section">
      <div class="menu-title">General</div>
      <a href="/blueprints" class="menu-item">
        <div class="icon">üóÇÔ∏è</div>
        Blueprints
      </a>
    </div>

    <!-- User -->
    <div class="user-profile">
      <div class="user-dropdown">
        <button class="user-dropdown-toggle" id="userProfileDropdownToggle" type="button" aria-expanded="false">
          <div class="user-avatar" id="sidebarProfilePicture">
            {% if user and user.profile_picture and user.profile_picture != '' and user.profile_picture != 'None' %}
              <img src="{{ user.profile_picture }}" alt="Profile Picture"
                   style="width:100%;height:100%;object-fit:cover;border-radius:50%;"
                   onerror="this.style.display='none'; this.parentNode.innerHTML='{{ user.username[0].upper() if user and user.username else 'U' }}';">
            {% else %}
              {{ user.username[0].upper() if user and user.username else 'U' }}
            {% endif %}
          </div>
          <div class="user-info">
            <div class="user-name">{{ user.first_name if user and user.first_name else user.username if user else 'Guest' }}</div>
            <div class="user-email">{{ user.email if user and user.email else user.username + '@engineroom.com' if user else 'user@engineroom.com' }}</div>
          </div>
        </button>
        <div class="user-dropdown-menu" id="userProfileDropdownMenu" style="display:none;">
          <a href="/dashboard-settings" class="dropdown-item"><div class="icon">‚öôÔ∏è</div><span>Settings</span></a>
          <form action="/logout" method="POST" style="display:contents;">
            <button type="submit" class="dropdown-item logout"><div class="icon">üö™</div><span>Logout</span></button>
          </form>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <header class="fixed-header-area">
      <div class="search-section" id="searchSection">
        <div class="search-container">
          <div class="search-input-wrapper">
            <input type="text" class="search-input" placeholder="Search projects..." id="projectSearch" />
            <div class="search-icon">üîç</div>
          </div>
          <button class="btn btn-primary" id="openAddProjectBtn" type="button">Add Project</button>
        </div>
      </div>
    </header>

    <section class="scrollable-content">
      <div class="content-grid">
        <section class="content-card" id="projectsView">
          <div class="card-header">
            <h3 class="card-title">Recent Projects</h3>
          </div>
          <div class="card-content">
            <div class="project-list">
              <div class="project-cards-container" id="recentProjectsContainer">
                <div class="no-recent-projects no-data-message">
                  <div style="font-size:3rem;opacity:.5;">üìã</div>
                  <p style="font-size:1.1rem;font-weight:600;margin:.4rem 0 .2rem;">No recent projects</p>
                  <p style="font-size:.9rem;">Create your first project to get started</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="content-card" id="allFilesView" style="margin-top:2rem;">
        <div class="card-header">
          <h3 class="card-title">All Projects</h3>
          <div class="card-header-actions">
            <select id="fileFilterSelect" class="filter-select" style="display:none;">
              <option value="all">All Projects</option>
              <option value="my">My Projects</option>
              <option value="team">Team Projects</option>
            </select>
          </div>
        </div>
        <div class="card-content">
          <div class="files-table-container">
            <table class="files-table" id="filesTable" aria-describedby="paginationInfo">
              <thead>
                <tr>
                  <th>Project Name</th>
                  <th>Client</th>
                  <th>Owner</th>
                  <th>Last Modified</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="filesTableBody">
                <tr class="no-data-row">
                  <td colspan="6" class="no-data-message">
                    <div style="font-size:3rem;opacity:.5;">üìã</div>
                    <p style="font-size:1.1rem;font-weight:600;margin:.4rem 0 .2rem;">No projects found</p>
                    <p style="font-size:.9rem;">Create your first project to get started</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info"><span id="paginationInfo">Showing 0 of 0</span></div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevPageBtn" disabled>‚Üê Previous</button>
              <div class="pagination-pages" id="paginationPages"></div>
              <button class="pagination-btn" id="nextPageBtn" disabled>Next ‚Üí</button>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Add Project Modal -->
  <div id="addProjectModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Project Setup</h3>
        <button class="close-modal-btn" data-close-modal="addProjectModal" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px; display:flex; align-items:center; gap:10px;">
          <div class="segment-switch" role="tablist" aria-label="Project sections">
            <button type="button" class="active" data-segment="overview" aria-selected="true">Project Overview</button>
            <button type="button" data-segment="settings" aria-selected="false">Project Settings</button>
          </div>
        </div>

        <form id="addProjectForm" novalidate>
          <!-- Overview -->
          <section data-section="overview" class="project-section" style="display:block;">
            <div class="grid-2" style="align-items:start; margin-bottom:16px;">
              <div>
                <div class="form-group">
                  <label for="projectName">Project Name *</label>
                  <input id="projectName" name="projectName" type="text" required placeholder="Enter project name" />
                  <div class="error-message" id="projectNameError"></div>
                </div>

                <div class="form-group">
                  <label for="projectNumber">Project Number</label>
                  <input id="projectNumber" name="projectNumber" type="text" placeholder="Enter project number" />
                </div>

                <div class="form-group">
                  <label for="clientName">Client Name</label>
                  <input id="clientName" name="clientName" type="text" placeholder="Enter client name" />
                </div>

                <div class="form-group">
                  <label for="siteAddress">Site Address *</label>
                  <div style="display:flex; gap:8px;">
                    <input id="siteAddress" name="siteAddress" type="text" required placeholder="Enter site address" />
                    <button type="button" id="locateAddressBtn" class="btn btn-secondary" disabled>Locate</button>
                  </div>
                  <div class="error-message" id="siteAddressError"></div>
                </div>
              </div>

              <div>
                <div class="map-shell"><div id="projectSetupMap" style="width:100%;height:100%;"></div></div>
              </div>
            </div>

            <div class="form-group">
              <label for="siteInformation">Site Information</label>
              <textarea id="siteInformation" name="siteInformation" rows="4" placeholder="Enter site information"></textarea>
            </div>
          </section>

          <!-- Settings -->
          <section data-section="settings" class="project-section" style="display:none;">
            <div class="form-group">
              <label for="projectType">Project Type</label>
              <select id="projectType" name="projectType">
                <option value="">Select project type</option>
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="industrial">Industrial</option>
                <option value="infrastructure">Infrastructure</option>
              </select>
            </div>

            <div class="form-group">
              <label for="projectUnits">Project Units</label>
              <select id="projectUnits" name="projectUnits">
                <option value="">Select measurement system</option>
                <option value="metric" selected>Metric (mm, m, kN)</option>
                <option value="imperial">Imperial (in, ft, lbs)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Project Visibility</label>
              <div style="display:flex; gap:14px; align-items:center;">
                <label><input type="radio" name="projectVisibility" value="private" checked> Private</label>
                <label><input type="radio" name="projectVisibility" value="team"> Team</label>
                <label><input type="radio" name="projectVisibility" value="public"> Public</label>
              </div>
            </div>

            <div class="form-group" id="teamMembersGroup" style="display:none;">
              <label for="teamMembers">Team Members</label>
              <input type="text" id="teamMembers" name="teamMembers" placeholder="EngineRoom usernames (comma separated)"/>
              <small style="color:#718096;">Add other EngineRoom users to collaborate on this project</small>
            </div>
          </section>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-modal="addProjectModal">Cancel</button>
            <button type="submit" class="btn btn-primary">Begin Project</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Team Setup Modal -->
  <div id="teamSetupModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="modal-content" style="max-width:520px;">
      <div class="modal-header">
        <h3>Set Up Your Team</h3>
        <button class="close-modal-btn" data-close-modal="teamSetupModal" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <form id="teamSetupForm" novalidate>
          <div class="form-group">
            <label for="teamName">Organisation or Team Name</label>
            <input type="text" id="teamName" name="teamName" required placeholder="Enter your name here"/>
          </div>
          <div class="form-group">
            <label for="teamSize">Expected Team Size</label>
            <select id="teamSize" name="teamSize" required>
              <option value="">Select team size</option>
              <option value="2-5">2-5 members</option>
              <option value="6-10">6-10 members</option>
              <option value="11-25">11-25 members</option>
              <option value="26+">26+ members</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-modal="teamSetupModal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Team</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Project Modal -->
  <div id="deleteProjectModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="modal-content" style="max-width:520px;">
      <div class="modal-header">
        <h3>Delete Project</h3>
        <button class="close-modal-btn" data-close-modal="deleteProjectModal" aria-label="Close">√ó</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "<strong id="deleteProjectName"></strong>"? This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" data-close-modal="deleteProjectModal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Project</button>
      </div>
    </div>
  </div>

  <!-- Optional: ADAM chat widget -->
  <script src="{{ url_for('static', filename='js/adam-chat-widget.js') }}"></script>

  <script>
    // Everything lives under window.Dashboard to avoid collisions
    (function () {
      const D = window.Dashboard = {
        state: {
          projects: [],
          filtered: [],
          page: 1,
          perPage: 12,
          deleteTarget: null,
          map: null,
          mapReady: false,
          mapSpin: true,
          userInteracting: false
        },

        els: {},

        qs(id) { return document.getElementById(id); },

        init() {
          // Cache elements
          D.els.projectCounter = D.qs('projectCounter');
          D.els.projectSearch  = D.qs('projectSearch');
          D.els.recentWrap     = D.qs('recentProjectsContainer');
          D.els.fileFilter     = D.qs('fileFilterSelect');
          D.els.tbody          = D.qs('filesTableBody');
          D.els.pagination     = D.qs('paginationContainer');
          D.els.paginationInfo = D.qs('paginationInfo');
          D.els.pagesWrap      = D.qs('paginationPages');
          D.els.prevBtn        = D.qs('prevPageBtn');
          D.els.nextBtn        = D.qs('nextPageBtn');

          // Modals
          D.els.addProjectModal  = D.qs('addProjectModal');
          D.els.teamSetupModal   = D.qs('teamSetupModal');
          D.els.deleteProjectModal = D.qs('deleteProjectModal');
          D.els.deleteProjectName  = D.qs('deleteProjectName');

          // Buttons
          D.qs('openAddProjectBtn')?.addEventListener('click', () => D.openModal('addProjectModal'));
          D.bindModalClose();
          D.bindUserDropdown();

          // Form + segments
          D.bindProjectSegments();
          D.bindAddProjectForm();
          D.bindTeamSetupForm();

          // Pagination
          D.els.prevBtn?.addEventListener('click', () => D.changePage(-1));
          D.els.nextBtn?.addEventListener('click', () => D.changePage(1));

          // Filters/search
          D.els.fileFilter?.addEventListener('change', () => { D.state.page = 1; D.renderTable(); });
          D.els.projectSearch?.addEventListener('input', D.debounce(() => D.applySearch(), 150));

          // Load team name (reveals filter if team exists)
          D.updateTeamMenuName();

          // Load projects
          D.loadProjects();

          // ADAM chat (best-effort)
          document.body.classList.add('authenticated');
          if (typeof ADAMChatWidget !== 'undefined' && !window.adamChat) {
            try { window.adamChat = new ADAMChatWidget(); } catch (e) { /* ignore */ }
          }
        },

        // ===== Utilities =====
        debounce(fn, wait=200) {
          let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this,args), wait); };
        },
        fmtDate(s) {
          const d = new Date(s || Date.now());
          return d.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
        },

        // ===== API =====
        async updateTeamMenuName() {
          try {
            const r = await fetch('/api/get-team-name');
            const data = await r.json();
            const teamItem = D.qs('teamMenuItem');
            const teamText = D.qs('teamMenuText');
            if (data?.success && data.team_name) {
              teamText.textContent = data.team_name;
              teamItem.style.display = 'flex';
              D.els.fileFilter.style.display = 'block';
            } else {
              teamItem.style.display = 'none';
              D.els.fileFilter.style.display = 'none';
            }
            // If user is team account without a team, prompt setup
            {% if user and user.get('account_type') == 'team' %}
            setTimeout(async () => {
              try {
                const u = await fetch('/api/get-user-profile').then(r => r.json());
                if (!u.team_id && u.account_type === 'team') D.openModal('teamSetupModal');
              } catch { /* ignore */ }
            }, 300);
            {% endif %}
          } catch {
            // Hide on error
            const teamItem = D.qs('teamMenuItem');
            if (teamItem) teamItem.style.display = 'none';
          }
        },

        async loadProjects() {
          try {
            const r = await fetch('/api/get-user-projects');
            const data = await r.json();
            if (data?.success && Array.isArray(data.projects)) {
              D.state.projects = data.projects.slice().sort((a,b) => new Date(b.modified||b.created) - new Date(a.modified||a.created));
            } else {
              D.state.projects = [];
            }
          } catch {
            D.state.projects = [];
          }
          D.state.filtered = D.state.projects.slice();
          D.updateProjectCounter(D.state.projects.length);
          D.renderRecent();
          D.renderTable();
        },

        async createProject(payload) {
          const r = await fetch('/api/create-project', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          return r.json();
        },

        async geocode(query) {
          const r = await fetch('/api/geocode-location', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ query })
          });
          return r.json();
        },

        async getMapboxToken() {
          try {
            const r = await fetch('/api/mapbox-token');
            const data = await r.json();
            return (data?.success && data.token) ? data.token : null;
          } catch { return null; }
        },

        // ===== Rendering =====
        updateProjectCounter(n) {
          if (D.els.projectCounter) D.els.projectCounter.textContent = n;
        },

        renderRecent() {
          const wrap = D.els.recentWrap;
          if (!wrap) return;
          if (!D.state.projects.length) {
            wrap.innerHTML = `
              <div class="no-recent-projects no-data-message">
                <div style="font-size:3rem;opacity:.5;">üìã</div>
                <p style="font-size:1.1rem;font-weight:600;margin:.4rem 0 .2rem;">No recent projects</p>
                <p style="font-size:.9rem;">Create your first project to get started</p>
              </div>`;
            return;
          }
          const recent = D.state.projects.slice(0,5);
          wrap.innerHTML = recent.map(p => `
            <div class="project-card" role="button" tabindex="0" onclick="Dashboard.openProject(${p.id})">
              <div class="project-card-header ${D.typeClass(p.type || p.status)}">
                <div class="project-card-icon">${D.typeIcon(p.type || p.status)}</div>
              </div>
              <div class="project-card-content">
                <h4 class="project-card-title">${p.name}</h4>
                <p class="project-card-meta">Modified: ${D.fmtDate(p.modified || p.created)}</p>
                <span class="project-card-status ${p.status || 'active'}">${D.statusText(p.status || 'active')}</span>
              </div>
            </div>
          `).join('');
        },

        renderTable() {
          const filter = D.els.fileFilter?.value || 'all';
          const q = (D.els.projectSearch?.value || '').toLowerCase().trim();

          // Base filter
          let list = D.state.projects.slice();
          if (filter === 'my')   list = list.filter(p => p.type === 'my');
          if (filter === 'team') list = list.filter(p => p.type === 'team');

          // Search filter
          if (q) {
            list = list.filter(p => {
              const blob = `${p.name||''} ${p.client||''} ${p.owner||''} ${p.status||''}`.toLowerCase();
              return blob.includes(q);
            });
          }
          D.state.filtered = list;

          const total = list.length;
          const pages = Math.max(1, Math.ceil(total / D.state.perPage));
          D.state.page = Math.min(D.state.page, pages);

          const start = (D.state.page - 1) * D.state.perPage;
          const end = Math.min(start + D.state.perPage, total);
          const slice = list.slice(start, end);

          if (!slice.length) {
            D.els.tbody.innerHTML = `
              <tr class="no-data-row">
                <td colspan="6" class="no-data-message">
                  <div style="font-size:3rem;opacity:.5;">üìã</div>
                  <p style="font-size:1.1rem;font-weight:600;margin:.4rem 0 .2rem;">No projects found</p>
                  <p style="font-size:.9rem;">Create your first project to get started</p>
                </td>
              </tr>`;
            D.els.pagination.style.display = 'none';
            return;
          }

          D.els.tbody.innerHTML = slice.map(p => `
            <tr data-project-id="${p.id}">
              <td class="project-name-cell">
                <a href="#" onclick="Dashboard.openProject(${p.id}); return false;" style="color:#547bf7;text-decoration:none;font-weight:600;">${p.name}</a>
              </td>
              <td>${p.client || 'N/A'}</td>
              <td>${p.owner || '‚Äî'}</td>
              <td>${D.fmtDate(p.modified || p.created)}</td>
              <td><span class="project-status-badge ${p.status || ''}">${D.statusText(p.status || 'active')}</span></td>
              <td>
                <div class="project-actions" style="display:flex;gap:6px;">
                  <button class="action-btn share btn btn-secondary" onclick="Dashboard.shareProject(${p.id})">Share</button>
                  <button class="action-btn delete btn btn-danger" onclick="Dashboard.askDelete(${p.id}, '${(p.name||'').replace(/'/g, "\\'")}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join('');

          D.els.pagination.style.display = (total > D.state.perPage) ? 'flex' : 'none';
          D.els.paginationInfo.textContent = `Showing ${start+1}-${end} of ${total} projects`;

          // Pages
          const maxVisible = 5;
          let s = Math.max(1, D.state.page - Math.floor(maxVisible/2));
          let e = Math.min(pages, s + maxVisible - 1);
          if (e - s + 1 < maxVisible) s = Math.max(1, e - maxVisible + 1);

          D.els.pagesWrap.innerHTML = '';
          for (let i=s;i<=e;i++) {
            const b = document.createElement('button');
            b.className = 'pagination-page' + (i===D.state.page ? ' active':'');
            b.textContent = i;
            b.addEventListener('click', () => { D.state.page = i; D.renderTable(); });
            D.els.pagesWrap.appendChild(b);
          }

          D.els.prevBtn.disabled = (D.state.page === 1);
          D.els.nextBtn.disabled = (D.state.page === pages);
        },

        changePage(delta) {
          const pages = Math.max(1, Math.ceil(D.state.filtered.length / D.state.perPage));
          const next = Math.min(Math.max(1, D.state.page + delta), pages);
          if (next !== D.state.page) { D.state.page = next; D.renderTable(); }
        },

        applySearch() { D.state.page = 1; D.renderTable(); },

        // ===== Actions =====
        openProject(id) { window.location.href = '/project/' + id; },

        shareProject(id) {
          const row = document.querySelector(`tr[data-project-id="${id}"]`);
          const name = row ? row.querySelector('.project-name-cell a')?.textContent || 'Project' : 'Project';
          const url = window.location.origin + '/site-selection?project=' + id + '&shared=true';
          navigator.clipboard?.writeText(url).then(
            () => alert(`Share link for "${name}" copied to clipboard!`),
            () => prompt(`Share this link for "${name}":`, url)
          );
        },

        askDelete(id, name) {
          D.state.deleteTarget = id;
          D.els.deleteProjectName.textContent = name || 'this project';
          D.openModal('deleteProjectModal');
        },

        async confirmDelete() {
          // Implement real delete API here if available.
          const id = D.state.deleteTarget;
          if (id != null) {
            // Local remove
            D.state.projects = D.state.projects.filter(p => p.id !== id);
            D.state.filtered = D.state.filtered.filter(p => p.id !== id);
            D.updateProjectCounter(D.state.projects.length);
            D.renderRecent();
            D.renderTable();
          }
          D.closeModal('deleteProjectModal');
        },

        // ===== Modal helpers =====
        openModal(id) {
          const m = D.qs(id);
          if (!m) return;
          m.setAttribute('aria-hidden', 'false');

          // Special: initialize map when opening addProject
          if (id === 'addProjectModal') {
            setTimeout(D.initSetupMap, 100);
            const form = D.qs('addProjectForm');
            if (form) form.reset();
            D.switchSegment('overview');
            D.qs('projectName')?.focus();
          }
        },
        closeModal(id) {
          const m = D.qs(id);
          if (m) m.setAttribute('aria-hidden', 'true');
        },
        bindModalClose() {
          document.body.addEventListener('click', (e) => {
            const target = e.target;
            // Close buttons
            if (target.matches('[data-close-modal]')) {
              D.closeModal(target.getAttribute('data-close-modal'));
            }
            // Click outside content closes modal
            const modal = target.closest('.modal');
            if (modal && target === modal) modal.setAttribute('aria-hidden', 'true');
          });
          D.qs('confirmDeleteBtn')?.addEventListener('click', D.confirmDelete);
        },

        // ===== User dropdown =====
        bindUserDropdown() {
          const toggle = D.qs('userProfileDropdownToggle');
          const menu   = D.qs('userProfileDropdownMenu');
          if (!toggle || !menu) return;
          toggle.addEventListener('click', () => {
            const open = menu.style.display === 'block';
            menu.style.display = open ? 'none' : 'block';
            toggle.setAttribute('aria-expanded', String(!open));
          });
          document.addEventListener('click', (e) => {
            if (!toggle.contains(e.target) && !menu.contains(e.target)) menu.style.display = 'none';
          });
        },

        // ===== Segments (Overview/Settings) =====
        bindProjectSegments() {
          document.querySelectorAll('.segment-switch button').forEach(btn => {
            btn.addEventListener('click', () => D.switchSegment(btn.dataset.segment));
          });
        },
        switchSegment(seg) {
          document.querySelectorAll('.segment-switch button').forEach(b => b.classList.toggle('active', b.dataset.segment === seg));
          document.querySelectorAll('[data-section]').forEach(sec => {
            sec.style.display = (sec.getAttribute('data-section') === seg) ? 'block' : 'none';
          });
          const vis = document.querySelector('input[name="projectVisibility"]:checked')?.value;
          D.qs('teamMembersGroup').style.display = (vis === 'team') ? 'block' : 'none';
        },

        // ===== Forms =====
        bindAddProjectForm() {
          const form = D.qs('addProjectForm');
          if (!form) return;

          // Visibility toggles team field
          form.addEventListener('change', (e) => {
            if (e.target.name === 'projectVisibility') {
              const vis = e.target.value;
              D.qs('teamMembersGroup').style.display = (vis === 'team') ? 'block' : 'none';
            }
          });

          // Address: enable locate when >= 3 chars
          const addr = D.qs('siteAddress');
          const locateBtn = D.qs('locateAddressBtn');
          addr?.addEventListener('input', D.debounce(() => {
            const ok = (addr.value.trim().length >= 3);
            locateBtn.disabled = !ok;
          }, 120));

          locateBtn?.addEventListener('click', D.locateAddress);

          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            D.clearAddProjectErrors();

            const payload = {
              name: (D.qs('projectName').value || '').trim(),
              projectNumber: (D.qs('projectNumber').value || '').trim(),
              clientName: (D.qs('clientName').value || '').trim(),
              address: (D.qs('siteAddress').value || '').trim(),
              siteInformation: (D.qs('siteInformation').value || '').trim(),
              projectType: (D.qs('projectType').value || '') || null,
              projectUnits: (D.qs('projectUnits').value || 'metric'),
              projectVisibility: document.querySelector('input[name="projectVisibility"]:checked')?.value || 'private',
              teamMembers: (D.qs('teamMembers')?.value || '').trim()
            };

            let errors = false;
            if (!payload.name) { D.qs('projectNameError').textContent = 'Project name is required'; errors = true; }
            if (!payload.address) { D.qs('siteAddressError').textContent = 'Site address is required'; errors = true; }
            if (errors) return;

            try {
              const res = await D.createProject(payload);
              if (res?.success) {
                sessionStorage.setItem('project_site_address', payload.address);
                sessionStorage.setItem('project_name', payload.name);
                D.closeModal('addProjectModal');
                // Go to site inspector
                window.location.href = '/site-inspector';
              } else {
                alert('Error creating project: ' + (res?.error || 'Unknown error'));
              }
            } catch (err) {
              alert('Error creating project. Please try again.');
            }
          });
        },

        clearAddProjectErrors() {
          D.qs('projectNameError').textContent = '';
          D.qs('siteAddressError').textContent = '';
        },

        bindTeamSetupForm() {
          const form = D.qs('teamSetupForm');
          if (!form) return;
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const payload = {
              teamName: fd.get('teamName'),
              teamDescription: '',
              teamSize: fd.get('teamSize')
            };
            try {
              const r = await fetch('/api/setup-team', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
              });
              if (r.ok) {
                D.closeModal('teamSetupModal');
                await D.updateTeamMenuName();
                location.reload();
              } else {
                const err = await r.json();
                alert('Failed to create team: ' + (err.message || 'Unknown error'));
              }
            } catch {
              alert('Failed to create team. Please try again.');
            }
          });
        },

        // ===== Map mini-setup =====
        async initSetupMap() {
          if (D.state.mapReady) return;
          const token = await D.getMapboxToken();
          if (!token) return;

          mapboxgl.accessToken = token;
          const map = new mapboxgl.Map({
            container: 'projectSetupMap',
            style: 'mapbox://styles/mapbox/streets-v12',
            projection: 'globe',
            center: [135, -25],
            zoom: 1.0,
            attributionControl: false,
            scrollZoom: true,
            boxZoom: false,
            doubleClickZoom: false,
            touchZoomRotate: false,
          });
          D.state.map = map;

          map.on('style.load', () => {
            map.setFog({ range: [0.5, 10], color: '#ffffff', horizon_blend: 0.1 });
          });

          map.on('mousedown', () => D.state.userInteracting = true);
          map.on('dragstart', () => D.state.userInteracting = true);
          map.on('dragend', () => {
            D.state.userInteracting = false;
            setTimeout(() => { if (!D.state.userInteracting) D.state.mapSpin = true; }, 2000);
          });

          (function spin() {
            if (D.state.mapSpin && !D.state.userInteracting && map.loaded()) {
              const c = map.getCenter(); c.lng -= 0.2;
              map.easeTo({ center: c, duration: 100 });
            }
            requestAnimationFrame(spin);
          })();

          map.on('load', () => { D.state.mapReady = true; });

          // keep a single marker instance
          D.state.mapMarker = null;
        },

        async locateAddress() {
          const btn = D.qs('locateAddressBtn');
          const val = (D.qs('siteAddress').value || '').trim();
          if (!D.state.mapReady || !val || val.length < 3) return;

          btn.disabled = true; const old = btn.textContent; btn.textContent = '...';
          try {
            const data = await D.geocode(val);
            if (data?.success && data.location) {
              const { lat, lng } = data.location;
              D.state.mapSpin = false; D.state.userInteracting = true;
              D.state.map.flyTo({
                center: [lng, lat], zoom: 16, duration: 2500, essential: true,
                curve: 1.2, easing: t => t < .5 ? 2*t*t : -1 + (4 - 2*t)*t
              });
              // marker
              if (D.state.mapMarker) D.state.mapMarker.remove();
              D.state.mapMarker = new mapboxgl.Marker({ color: '#4f7cff' })
                .setLngLat([lng, lat]).addTo(D.state.map);
            } else {
              alert('Could not locate that address. Try a more specific query.');
            }
          } catch {
            alert('Geocoding failed. Please try again.');
          } finally {
            btn.disabled = false; btn.textContent = old;
          }
        },

        // ===== Mappers =====
        typeClass(t) {
          const m = {
            structural: 'structural', 'structural-analyser': 'structural', 'structure-designer': 'structural',
            site: 'site', 'site-selection': 'site', 'site-inspector': 'site', 'terrain-analysis': 'site',
            building: 'building', residential: 'building', commercial: 'building', industrial: 'building'
          };
          return m[t] || 'building';
        },
        typeIcon(t) {
          const m = {
            structural:'üèóÔ∏è','structural-analyser':'‚öôÔ∏è','structure-designer':'üèóÔ∏è',
            site:'üó∫Ô∏è','site-selection':'üìç','site-inspector':'üîç','terrain-analysis':'üèîÔ∏è',
            building:'üè¢',residential:'üè†',commercial:'üè¢',industrial:'üè≠'
          };
          return m[t] || 'üìã';
        },
        statusText(s) {
          const m = {
            'site-selection':'Site Selection','site-inspector':'Site Inspector','terrain-analysis':'Terrain Analysis',
            'structure-designer':'Structure Designer','structural-analyser':'Structural Analyser',
            active:'Active',completed:'Completed',pending:'Pending'
          };
          return m[s] || s || 'Active';
        }
      };

      // boot
      document.addEventListener('DOMContentLoaded', D.init);
      // expose for onclick handlers in generated HTML
      window.Dashboard = D;
    })();
  </script>
</body>
</html>