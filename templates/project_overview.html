<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ project.name }} - EngineRoom</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='ER Logo_1749447115584.png') }}">

  <!-- Mapbox (v3 as in your original) -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet"/>

  <!-- ADAM chat widget styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/adam-chat-widget.css') }}"/>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #2d3748; overflow-x: hidden; }

    /* Fixed Header */
    .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #fff; border-bottom: 1px solid #e2e8f0; padding: 1rem 2rem; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,.1); height: 80px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; height: 48px; }
    .breadcrumb { display: flex; align-items: center; gap: .5rem; font-size: .9rem; }
    .breadcrumb a { color: #547bf7; text-decoration: none; font-weight: 500; }
    .breadcrumb a:hover { text-decoration: underline; }
    .breadcrumb span { color: #718096; }
    .header-cta-btn { background: linear-gradient(135deg,#547bf7,#4a6bda); color:#fff; border: 0; border-radius: 8px; padding: 0 20px; height: 40px; font-weight: 600; cursor: pointer; font-size: 14px; display:flex; align-items:center; gap:8px; box-shadow: 0 0 0 rgba(0,0,0,0); transition: .2s; text-decoration: none; }
    .header-cta-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(84,123,247,.3); }

    /* Layout */
    .page-container { display: flex; margin-top: 80px; min-height: calc(100vh - 80px); }
    .main-content { flex: 1; padding: 2rem; margin-right: 320px; min-width: 0; }

    /* Right history sidebar */
    .history-sidebar { position: fixed; top: 80px; right: 0; width: 320px; height: calc(100vh - 80px); background:#fff; border-left:1px solid #e2e8f0; overflow-y: auto; z-index: 100; }
    .history-header { padding: 2rem 2rem 1rem; border-bottom: 1px solid #e2e8f0; background:#f8fafc; }
    .history-title { font-size: 1.25rem; font-weight: 700; color:#1a202c; }
    .history-content { padding: 1rem 2rem; }
    .history-item { display:flex; align-items:flex-start; gap:.75rem; padding:.75rem 0; border-bottom:1px solid #f1f5f9; }
    .history-item:last-child { border-bottom: none; }
    .history-icon { width: 32px; height: 32px; border-radius: 50%; background:#f8fafc; border:2px solid #e2e8f0; display:flex; align-items:center; justify-content:center; font-size:.875rem; flex-shrink:0; }
    .history-description { font-size: .85rem; color:#2d3748; margin-bottom: .25rem; }
    .history-meta { display:flex; align-items:center; gap:.5rem; font-size:.75rem; color:#718096; }
    .history-user { font-weight:600; color:#547bf7; }

    /* Cards */
    .content-card { background:#fff; border-radius:12px; margin-bottom:2rem; box-shadow:0 1px 3px rgba(0,0,0,.1); border:1px solid #e2e8f0; overflow: hidden; }
    .card-header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid #e2e8f0; background:#f8fafc; }
    .card-title { font-size:1.1rem; font-weight:600; color:#1a202c; }
    .card-content { padding: 2rem; }

    /* Project header card */
    .project-header-card { max-width: 800px; }
    .project-title-section { display:flex; justify-content:space-between; align-items:flex-start; padding: 2rem 2rem 0; }
    .project-title { font-size: 1.75rem; font-weight: 700; color:#1a202c; margin: 0 0 .5rem; }
    .project-address { color:#718096; font-size:.95rem; }
    .project-status { display:inline-block; padding:.5rem 1rem; border-radius: 20px; font-size:.75rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; background:#c6f6d5; color:#22543d; }
    .settings-btn { width: 40px; height: 40px; border:1px solid #e2e8f0; border-radius: 8px; background:#f8fafc; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; transition:.2s; }
    .settings-btn:hover { background:#e2e8f0; border-color:#cbd5e0; transform: translateY(-1px); }

    .snapshot-preview { height: 400px; background:#f8f9fa; display:flex; align-items:center; justify-content:center; }
    .snapshot-placeholder { text-align:center; color:#718096; }
    .snapshot-icon { font-size: 3rem; opacity:.3; }

    .project-meta-grid { padding: 2rem; display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:1.5rem; }
    .meta-item { display:flex; flex-direction:column; gap:.25rem; }
    .meta-label { font-size:.75rem; font-weight:600; color:#718096; text-transform:uppercase; letter-spacing:.05em; }
    .meta-value { font-size:.9rem; color:#2d3748; font-weight:500; }

    .no-data { text-align:center; color:#718096; font-style: italic; padding: 3rem 1rem; font-size: .9rem; }

    /* Team profile */
    .team-member { display:flex; align-items:center; gap:.75rem; padding:1rem; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:.75rem; transition:.2s; }
    .team-member:hover { border-color:#cbd5e0; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .member-avatar { width:40px; height:40px; border-radius:50%; background:#547bf7; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:.9rem; flex-shrink:0; overflow: hidden; }
    .member-info { flex:1; min-width:0; }
    .member-name { font-weight:600; color:#2d3748; font-size:.9rem; margin-bottom:.125rem; }
    .member-role { font-size:.8rem; color:#718096; }
    .active-badge { display:inline-block; background:#10b981; color:#fff; font-size:.6rem; font-weight:700; padding:.125rem .375rem; border-radius:10px; margin-left:.5rem; text-transform:uppercase; letter-spacing:.025em; }

    /* Flow progress */
    .flow-progress { width: 100%; }
    .progress-steps { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; position: relative; }
    .progress-step { display:flex; flex-direction:column; align-items:center; position:relative; width:20%; cursor: pointer; transition:.2s; }
    .progress-step:hover { transform: translateY(-2px); }
    .step-circle { width:30px; height:30px; border-radius:50%; background:#e2e8f0; color:#718096; display:flex; align-items:center; justify-content:center; font-size:.875rem; font-weight:600; z-index:1; }
    .progress-step.current .step-circle { background:#547bf7; color:#fff; }
    .progress-step.completed .step-circle { background:#10b981; color:#fff; }
    .step-label { font-size:.75rem; color:#4a5568; margin-top:.5rem; text-align:center; }
    .progress-connector { position:absolute; top:15px; left:0; right:0; height:4px; background:#e2e8f0; z-index:0; }
    .progress-summary { font-size:.875rem; color:#2d3748; }

    /* Settings modal */
    .settings-modal { display:none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,.5); align-items:center; justify-content:center; }
    .settings-modal.active { display:flex; }
    .settings-modal-content { background:#fff; border-radius:12px; padding:2rem; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 25px -5px rgba(0,0,0,.1); }
    .settings-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid #e2e8f0; }
    .settings-modal-title { font-size:1.25rem; font-weight:700; color:#1a202c; }
    .close-btn { background:none; border:0; font-size:1.5rem; cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:4px; color:#718096; }
    .close-btn:hover { background:#f7fafc; color:#4a5568; }
    .settings-form-group { margin-bottom:1.25rem; }
    .settings-form-label { display:block; font-size:.875rem; font-weight:600; color:#374151; margin-bottom:.5rem; }
    .settings-form-select { width:100%; padding:.75rem; border:1px solid #e2e8f0; border-radius:6px; font-size:.9rem; background:#fff; color:#2d3748; }
    .settings-form-select:focus { outline:none; border-color:#547bf7; box-shadow:0 0 0 3px rgba(84,123,247,.1); }
    .settings-form-actions { display:flex; gap:.75rem; justify-content:flex-end; margin-top:1.25rem; }
    .btn-save { background:#547bf7; color:#fff; border:0; padding:.75rem 1.25rem; border-radius:6px; font-size:.875rem; font-weight:700; cursor:pointer; }
    .btn-cancel { background:#e2e8f0; color:#4a5568; border:0; padding:.75rem 1.25rem; border-radius:6px; font-size:.875rem; font-weight:600; cursor:pointer; }

    /* Hide Mapbox attribution/logo in the snapshot preview only */
    .snapshot-preview .mapboxgl-ctrl-logo,
    .snapshot-preview .mapboxgl-ctrl-attrib,
    .snapshot-preview .mapboxgl-ctrl-attrib-button,
    .snapshot-preview .mapboxgl-ctrl-attrib-inner { display:none !important; }
  </style>
</head>
<body class="authenticated">
  <!-- Fixed Header -->
  <div class="fixed-header">
    <div class="header-content">
      <div class="breadcrumb">
        <a href="/dashboard">Dashboard</a><span>/</span><span>{{ project.name }}</span>
      </div>
      <a href="{{ flow_step.route_url }}?project={{ project.id }}" class="header-cta-btn">{{ flow_step.button_text }}</a>
    </div>
  </div>

  <div class="page-container">
    <div class="main-content">
      <!-- Project Header -->
      <div class="content-card project-header-card">
        <div class="project-title-section">
          <div>
            <h1 class="project-title">{{ project.name }}</h1>
            <p class="project-address">{{ project.address }}</p>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <span class="project-status status-{{ project.status }}">{{ project.status }}</span>
            <button class="settings-btn" id="openSettingsBtn" title="Project Settings">⚙️</button>
          </div>
        </div>

        <!-- Snapshot -->
        <div class="snapshot-preview" id="snapshotPreview">
          <div class="snapshot-placeholder">
            <div class="snapshot-icon">📋</div>
            <div style="margin-top:.5rem; font-size:.9rem;">Loading snapshot…</div>
          </div>
        </div>

        <!-- Meta -->
        <div class="project-meta-grid">
          <div class="meta-item">
            <span class="meta-label">Project Number</span>
            <span class="meta-value">{{ project.project_number or 'Not assigned' }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Client</span>
            <span class="meta-value">{{ project.client_name or 'Not specified' }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Project Type</span>
            <span class="meta-value">{{ project.project_type or 'Not specified' }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Owner</span>
            <span class="meta-value">{{ project.owner }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Created</span>
            <span class="meta-value">
              {% if project.created_at %}
                {% if project.created_at.__class__.__name__ == 'datetime' %}
                  {{ project.created_at.strftime('%B %d, %Y') }}
                {% else %}
                  {{ project.created_at }}
                {% endif %}
              {% else %}Unknown{% endif %}
            </span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Last Modified</span>
            <span class="meta-value">
              {% if project.updated_at %}
                {% if project.updated_at.__class__.__name__ == 'datetime' %}
                  {{ project.updated_at.strftime('%B %d, %Y at %I:%M %p') }}
                {% else %}
                  {{ project.updated_at }}
                {% endif %}
              {% else %}Unknown{% endif %}
            </span>
          </div>
        </div>
      </div>

      <!-- Flow Progress -->
      <div class="content-card">
        <div class="card-header"><h3 class="card-title">Engineering Flow Progress</h3></div>
        <div class="card-content">
          <div class="flow-progress">
            <div class="progress-steps">
              <div class="progress-connector"></div>

              <div class="progress-step {{ 'completed' if flow_step.current_step > 1 else 'current' if flow_step.current_step == 1 else '' }}"
                   onclick="ProjectOverview.goStep(1, {{ project.id }})">
                <div class="step-circle">1</div>
                <div class="step-label">Site Inspector</div>
              </div>

              <div class="progress-step {{ 'completed' if flow_step.current_step > 2 else 'current' if flow_step.current_step == 2 else '' }}"
                   onclick="ProjectOverview.goStep(2, {{ project.id }})">
                <div class="step-circle">2</div>
                <div class="step-label">Cut &amp; Fill Analysis</div>
              </div>

              <div class="progress-step {{ 'completed' if flow_step.current_step > 3 else 'current' if flow_step.current_step == 3 else '' }}"
                   onclick="ProjectOverview.goStep(3, {{ project.id }})">
                <div class="step-circle">3</div>
                <div class="step-label">FormLab</div>
              </div>

              <div class="progress-step {{ 'completed' if flow_step.current_step > 4 else 'current' if flow_step.current_step == 4 else '' }}"
                   onclick="ProjectOverview.goStep(4, {{ project.id }})">
                <div class="step-circle">4</div>
                <div class="step-label">Structure Designer</div>
              </div>

              <div class="progress-step {{ 'completed' if flow_step.current_step > 5 else 'current' if flow_step.current_step == 5 else '' }}"
                   onclick="ProjectOverview.goStep(5, {{ project.id }})">
                <div class="step-circle">5</div>
                <div class="step-label">Structure Analyser</div>
              </div>
            </div>

            <div class="progress-summary">
              <p>Currently on: <strong>{{ flow_step.step_name }}</strong></p>
              {% if flow_step.current_step < 4 %}
                <p>Next: {{ flow_step.next_step_name }}</p>
              {% else %}
                <p>Engineering flow completed! ✅</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Team Profile -->
      <div class="content-card team-profile">
        <div class="card-header"><h3 class="card-title">Team Profile</h3></div>
        <div class="card-content">
          <!-- Owner -->
          <div class="team-member">
            <div class="member-avatar">
              {% if user and user.profile_picture %}
                <img src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture.split('/')[-1]) }}"
                     alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
              {% else %}
                {{ project.owner[0].upper() if project.owner else 'U' }}
              {% endif %}
            </div>
            <div class="member-info">
              <div class="member-name">
                {{ project.owner }}
                {% if user and user.username == project.owner %}
                  <span class="active-badge">Active</span>
                {% endif %}
              </div>
              <div class="member-role">Project Owner</div>
            </div>
          </div>

          <!-- Members -->
          {% if team_members and team_members|length %}
            {% for member in team_members %}
              <div class="team-member">
                <div class="member-avatar">
                  {% if member.profile_picture %}
                    <img src="{{ url_for('static', filename='uploads/profile_pictures/' + member.profile_picture.split('/')[-1]) }}"
                         alt="Profile Picture" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
                  {% else %}
                    {{ member.display_name[0].upper() if member.display_name else 'U' }}
                  {% endif %}
                </div>
                <div class="member-info">
                  <div class="member-name">
                    {{ member.display_name }}
                    {% if user and user.id == member.id %}
                      <span class="active-badge">Active</span>
                    {% endif %}
                  </div>
                  <div class="member-role">{{ member.role or 'Team Member' }}</div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="no-data">
              <div style="font-size:2rem;margin-bottom:.5rem;">📋</div>
              Project not shared with team members yet.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Sidebar: Project History -->
    <aside class="history-sidebar">
      <div class="history-header"><h3 class="history-title">Project History</h3></div>
      <div class="history-content">
        {% if project_history and project_history|length %}
          {% for event in project_history %}
            <div class="history-item">
              <div class="history-icon">
                {% if event.event_type == 'created' %}📋
                {% elif event.event_type == 'note_added' %}📝
                {% elif event.event_type == 'comment_added' %}💬
                {% elif event.event_type == 'member_joined' %}👥
                {% elif event.event_type == 'status_changed' %}🔄
                {% else %}📌{% endif %}
              </div>
              <div class="history-details">
                <div class="history-description">{{ event.description }}</div>
                <div class="history-meta">
                  <span class="history-user">{{ event.user_name }}</span><span>•</span>
                  <span>
                    {% if event.created_at %}
                      {% if event.created_at.__class__.__name__ == 'datetime' %}
                        {{ event.created_at.strftime('%b %d at %I:%M %p') }}
                      {% else %}
                        {{ event.created_at }}
                      {% endif %}
                    {% else %}Unknown time{% endif %}
                  </span>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-data">
            <div style="font-size: 2rem; margin-bottom: .5rem;">📋</div>
            <p>Project history will appear here</p>
          </div>
        {% endif %}
      </div>
    </aside>
  </div>

  <!-- Project Settings Modal -->
  <div class="settings-modal" id="projectSettingsModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h3 class="settings-modal-title">Project Settings</h3>
        <button class="close-btn" id="closeSettingsBtn" aria-label="Close">×</button>
      </div>

      <form id="projectSettingsForm">
        <div class="settings-form-group">
          <label class="settings-form-label" for="projectUnits">Units</label>
          <select class="settings-form-select" id="projectUnits" name="units">
            <option value="metric" {{ 'selected' if project.project_units == 'metric' else '' }}>Metric</option>
            <option value="imperial" {{ 'selected' if project.project_units == 'imperial' else '' }}>Imperial</option>
          </select>
        </div>

        <div class="settings-form-group">
          <label class="settings-form-label" for="projectVisibility">Visibility</label>
          <select class="settings-form-select" id="projectVisibility" name="visibility">
            <option value="private" {{ 'selected' if project.project_visibility == 'private' else '' }}>Private</option>
            <option value="team" {{ 'selected' if project.project_visibility == 'team' else '' }}>Team</option>
            <option value="public" {{ 'selected' if project.project_visibility == 'public' else '' }}>Public</option>
          </select>
        </div>

        <div class="settings-form-actions">
          <button type="button" class="btn-cancel" id="cancelSettingsBtn">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Optional app scripts (keep if you rely on them elsewhere) -->
  <script src="/static/js/core.js"></script>
  <script src="/static/js/timezone-detector.js"></script>
  <script src="/static/js/snapshot-manager.js"></script>
  <script src="/static/js/adam-chat-widget.js"></script>
  <script src="/static/app.js"></script>

  <script>
    // Namespace everything to avoid collisions
    (function() {
      const P = window.ProjectOverview = {
        els: {},
        state: { snapshotLoaded: false },

        qs(id){ return document.getElementById(id); },

        init() {
          // cache
          P.els.snapshot = P.qs('snapshotPreview');
          P.els.settingsModal = P.qs('projectSettingsModal');
          P.els.openSettingsBtn = P.qs('openSettingsBtn');
          P.els.closeSettingsBtn = P.qs('closeSettingsBtn');
          P.els.cancelSettingsBtn = P.qs('cancelSettingsBtn');
          P.els.settingsForm = P.qs('projectSettingsForm');

          // events
          P.els.openSettingsBtn?.addEventListener('click', P.openSettings);
          P.els.closeSettingsBtn?.addEventListener('click', P.closeSettings);
          P.els.cancelSettingsBtn?.addEventListener('click', P.closeSettings);
          P.els.settingsModal?.addEventListener('click', (e)=>{ if(e.target===P.els.settingsModal) P.closeSettings(); });
          P.els.settingsForm?.addEventListener('submit', P.saveSettings);

          // Load snapshot
          P.loadSnapshot();

          // ADAM chat best-effort
          document.body.classList.add('authenticated');
          if (typeof ADAMChatWidget !== 'undefined' && !window.adamChat) {
            try { window.adamChat = new ADAMChatWidget(); } catch(e) {}
          }

          // External snapshot manager hook (if present)
          if (typeof initializeSnapshotManager === 'function') {
            initializeSnapshotManager({{ project.id }});
          }

          {% if site_data %}
            console.log('[ProjectOverview] Site data loaded successfully!');
          {% else %}
            console.log('[ProjectOverview] No site data available');
          {% endif %}
        },

        // -------- Snapshot --------
        async loadSnapshot() {
          try {
            const r = await fetch(`/api/project/{{ project.id }}/snapshot`);
            if (!r.ok) return P.noSnapshot();
            const data = await r.json();
            if (data?.success && data.snapshot) {
              P.renderSnapshot(data.snapshot);
            } else P.noSnapshot();
          } catch(e) {
            console.error('Snapshot load error:', e);
            P.noSnapshot();
          }
        },

        noSnapshot() {
          if (!P.els.snapshot) return;
          P.els.snapshot.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;text-align:center;">
              <div>
                <div style="font-size:2rem;margin-bottom:.5rem;">📋</div>
                <p>No project snapshot available</p>
                <p style="font-size:.875rem;opacity:.7;">Complete the site inspector to see a preview</p>
              </div>
            </div>`;
        },

        parseSnapshotData(snapshot) {
          let d = snapshot.snapshot_data;
          if (typeof d === 'object' && d) return d;
          try { return JSON.parse(d); }
          catch {
            try {
              // basic Python-dict style -> JSON
              const s = String(d).replace(/'/g,'"').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false').replace(/\bNone\b/g,'null');
              return JSON.parse(s);
            } catch { return null; }
          }
        },

        renderSnapshot(snapshot) {
          const data = P.parseSnapshotData(snapshot) || {};
          const container = P.els.snapshot;
          if (!container) return;

          const type = snapshot.snapshot_type;
          if (type === 'site_boundary') return P.renderSiteBoundary(data, container);
          if (type === 'buildable_area') return P.renderBuildableArea(data, container);
          if (type === 'structure_design') return P.renderPlaceholder(container, '🏗️', 'Structure Design', `${data.structure_type || 'Structure'} designed`);
          if (type === 'structural_analysis') return P.renderPlaceholder(container, '🔧', 'Structural Analysis', `Analysis ${data.status || 'completed'}`);
          if (type === 'terrain_analysis') return P.renderPlaceholder(container, '🏔️', 'Terrain Analysis', 'Terrain analysis completed');
          return P.renderPlaceholder(container, '📋', type || 'Snapshot', snapshot.description || 'Snapshot available');
        },

        async getToken() {
          try {
            const r = await fetch('/api/mapbox-token');
            const j = await r.json();
            return j?.success && j.token ? j.token : null;
          } catch { return null; }
        },

        // ---- Specific renderers ----
        async renderSiteBoundary(data, container) {
          const coords = data.coordinates || data.coords || null;
          if (!Array.isArray(coords) || coords.length < 3) return P.renderPlaceholder(container,'🗺️','Site Boundary','Boundary data not available');

          const token = await P.getToken();
          if (!token) return P.canvasSiteBoundary(container, coords);

          mapboxgl.accessToken = token;
          const id = `map-${Date.now()}`;
          container.innerHTML = `<div id="${id}" style="width:100%;height:100%;"></div>`;

          const points = coords.map(c => Array.isArray(c) ? [c[0], c[1]] : [c.lng || c.x, c.lat || c.y]);
          const lngs = points.map(p=>p[0]), lats = points.map(p=>p[1]);
          const bounds = [[Math.min(...lngs), Math.min(...lats)], [Math.max(...lngs), Math.max(...lats)]];

          const map = new mapboxgl.Map({
            container: id,
            style: 'mapbox://styles/mapbox/outdoors-v12',
            bounds, fitBoundsOptions: { padding: 40 },
            attributionControl: false, interactive: false
          });

          map.on('load', () => {
            map.addSource('site-boundary', {
              type:'geojson',
              data:{ type:'Feature', geometry:{ type:'Polygon', coordinates:[points.concat([points[0]])] } }
            });
            map.addLayer({ id:'site-boundary-fill', type:'fill', source:'site-boundary',
              paint:{ 'fill-color':'#547bf7', 'fill-opacity':0.3 }});
            map.addLayer({ id:'site-boundary-outline', type:'line', source:'site-boundary',
              paint:{ 'line-color':'#547bf7', 'line-width':3 }});
          });
        },

        async renderBuildableArea(data, container) {
          const coords = data.buildable_coords || data.coordinates || null;
          if (!Array.isArray(coords) || coords.length < 3) {
            return P.renderPlaceholder(container,'📐','Buildable Area','Buildable area data not available');
          }

          const token = await P.getToken();
          if (!token) return P.canvasBuildable(container, coords);

          mapboxgl.accessToken = token;
          const id = `map-${Date.now()}`;
          container.innerHTML = `<div id="${id}" style="width:100%;height:100%;"></div>`;

          const points = coords.map(c => Array.isArray(c) ? [c[0], c[1]] : [c.lng || c.x, c.lat || c.y]);
          const lngs = points.map(p=>p[0]), lats = points.map(p=>p[1]);
          const bounds = [[Math.min(...lngs), Math.min(...lats)], [Math.max(...lngs), Math.max(...lats)]];

          const map = new mapboxgl.Map({
            container: id,
            style: 'mapbox://styles/mapbox/outdoors-v12',
            bounds, fitBoundsOptions: { padding: 40 },
            attributionControl: false, interactive: false
          });

          map.on('load', () => {
            map.addSource('buildable-area', {
              type:'geojson',
              data:{ type:'Feature', geometry:{ type:'Polygon', coordinates:[points.concat([points[0]])] } }
            });
            map.addLayer({ id:'buildable-area-fill', type:'fill', source:'buildable-area',
              paint:{ 'fill-color':'#002040', 'fill-opacity':0.4 }});
            map.addLayer({ id:'buildable-area-outline', type:'line', source:'buildable-area',
              paint:{ 'line-color':'#002040', 'line-width':3 }});
          });
        },

        // ---- Canvas fallbacks ----
        canvasSiteBoundary(container, coordinates) {
          P.canvasPolygon(container, coordinates, '#007cbf', 'rgba(0,124,191,0.2)');
        },
        canvasBuildable(container, coordinates) {
          P.canvasPolygon(container, coordinates, '#002040', 'rgba(0,32,64,0.4)');
        },
        canvasPolygon(container, coordinates, stroke, fill) {
          const canvas = document.createElement('canvas');
          canvas.width = container.clientWidth || 400;
          canvas.height = container.clientHeight || 300;
          canvas.style.width = '100%'; canvas.style.height = '100%';
          container.innerHTML = ''; container.appendChild(canvas);
          const ctx = canvas.getContext('2d');

          const { minX, minY, width, height } = P.bounds(coordinates);
          const scale = Math.min(canvas.width / width, canvas.height / height) * 0.8;
          const offX = (canvas.width - width * scale) / 2 - minX * scale;
          const offY = (canvas.height - height * scale) / 2 - minY * scale;

          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.beginPath(); ctx.strokeStyle = stroke; ctx.fillStyle = fill; ctx.lineWidth = 2;

          coordinates.forEach((c,i) => {
            const x = (Array.isArray(c)?c[0]:c.x) * scale + offX;
            const yv = (Array.isArray(c)?c[1]:c.y) * scale + offY;
            const y = canvas.height - yv; // flip Y
            if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          });
          ctx.closePath(); ctx.fill(); ctx.stroke();

          // vertices
          ctx.fillStyle = stroke;
          coordinates.forEach(c => {
            const x = (Array.isArray(c)?c[0]:c.x) * scale + offX;
            const yv = (Array.isArray(c)?c[1]:c.y) * scale + offY;
            const y = canvas.height - yv;
            ctx.beginPath(); ctx.arc(x,y,3,0,2*Math.PI); ctx.fill();
          });
        },
        bounds(coordinates) {
          let minX= Infinity, minY= Infinity, maxX= -Infinity, maxY= -Infinity;
          coordinates.forEach(c => {
            const x = Array.isArray(c)?c[0]:c.x;
            const y = Array.isArray(c)?c[1]:c.y;
            minX = Math.min(minX,x); minY = Math.min(minY,y);
            maxX = Math.max(maxX,x); maxY = Math.max(maxY,y);
          });
          return { minX, minY, maxX, maxY, width: maxX - minX, height: maxY - minY };
        },

        renderPlaceholder(container, icon, title, desc) {
          container.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100%;text-align:center;">
              <div>
                <div style="font-size:3rem;margin-bottom:1rem;">${icon}</div>
                <h3 style="margin:0 0 .5rem 0;color:#333;">${title}</h3>
                <p style="margin:0;font-size:.875rem;opacity:.7;">${desc || ''}</p>
              </div>
            </div>`;
        },

        // -------- Settings Modal --------
        openSettings() { P.els.settingsModal?.classList.add('active'); },
        closeSettings() { P.els.settingsModal?.classList.remove('active'); },
        async saveSettings(e) {
          e.preventDefault();
          const fd = new FormData(P.els.settingsForm);
          const settings = { units: fd.get('units'), visibility: fd.get('visibility') };
          try {
            const r = await fetch(`/api/project/{{ project.id }}/settings`, {
              method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(settings)
            });
            if (r.ok) { P.closeSettings(); location.reload(); }
            else alert('Failed to save settings. Please try again.');
          } catch(err) {
            console.error('Settings save error', err);
            alert('Failed to save settings. Please try again.');
          }
        },

        // -------- Navigation --------
        goStep(n, projectId) {
          const id = (projectId ?? {{ project.id }});
          const routes = {
            1: `/site-inspector?project_id=${id}`,
            2: `/terrain-viewer?project_id=${id}`,
            3: `/site-developer?project_id=${id}`,
            4: `/structure-designer?project_id=${id}`,
            5: `/structural-analyser?project_id=${id}`
          };
          if (routes[n]) window.location.href = routes[n];
        }
      };

      document.addEventListener('DOMContentLoaded', P.init);
      window.ProjectOverview = P; // expose for onclicks
    })();
  </script>
</body>
</html>